---
title: "AIエージェント時代に必須となる「防御的プロンプト設計」という思考法"
emoji: "🛡️"
type: "tech"
topics: ["ai", "claude", "promptengineering", "security", "devops"]
published: true
---

## はじめに:「AIは言われた通りに動く」という恐怖

最近、AIエージェントによるトラブル事例を立て続けに目にしました。OpenAIのGPTBotが1日15万回もサイトをクロールしてDDoS攻撃同然の負荷をかけた事例や、Claude Code Agentで1行もコードを書かずにアプリを作れた成功体験など、AI活用の光と影が同時に見えてきています。

これらの事例から見えてくるのは、**AIは「賢く判断する」のではなく「指示を忠実に実行する」**という本質です。そしてこの特性こそが、私たちエンジニアに新しい設計思想を求めています。

## GPTBotの暴走が教えてくれたこと

GPTBotが1日15万回のアクセスを行った事例は示唆に富んでいます。OpenAI側からすれば「効率的にWebをクロールする」という目的を達成しているだけです。しかし受ける側にとっては立派なDDoS攻撃です。

これは単なるバグではありません。**目的関数の最適化としては正しい挙動**なのです。「なるべく多くのデータを集める」という指示に対して、レート制限や相手サーバーへの配慮という「暗黙の制約」が組み込まれていなかっただけです。

## 防御的プロンプト設計の3原則

私がAIエージェントを使う際に意識している設計原則を紹介します。

### 1. 明示的な禁止事項を先に定義する

```markdown
# 絶対にしてはいけないこと
- /etc, /sys, /procディレクトリへの書き込み
- .gitディレクトリの削除や変更
- package.jsonのdevDependenciesの削除
- 実行中プロセスの強制終了
```

Claude Computer Useなどのデスクトップ操作型AIには、このような「Mutex(排他制御)リスト」を必ずプロンプトの冒頭に含めます。人間にとっての「常識」はAIには存在しません。

### 2. スコープの限定と段階的実行

「PCを軽くして」という曖昧な指示は危険です。代わりに:

```markdown
1. ~/Downloads配下の30日以上前のファイルをリストアップ
2. リストを表示して確認を求める
3. 承認後に削除実行
```

このように、**観測→承認→実行**のサイクルを明示的に組み込みます。

### 3. レート制限の明示

GPTBotの事例から学ぶべきは、外部リソースへのアクセスには必ず制限を設けることです。

```markdown
# API呼び出しルール
- 1秒あたり最大2リクエスト
- エラー時は指数バックオフで再試行
- 連続失敗3回で人間に報告して停止
```

## 実践例:Claude Codeでの家計簿アプリ開発

「1行もコードを書かずに家計簿アプリを作った」という事例は、AIの可能性を示す一方で、設計の重要性も浮き彫りにしています。

私が同様のアプローチを取る際は、こんなプロンプト構造にします:

```markdown
# プロジェクト制約
- データベース: SQLiteのみ(PostgreSQL等の外部DBは使用禁止)
- 外部API呼び出し: 事前承認制
- ファイル操作: プロジェクトディレクトリ内のみ
- パッケージ追加: package.jsonへの追加前に確認

# セキュリティ要件
- ユーザー入力は必ずバリデーション
- SQLインジェクション対策必須
- 機密情報のログ出力禁止
```

## AIエージェント時代のエンジニアリング

従来のプログラミングでは「どう実装するか」が中心でしたが、AIエージェント時代には**「何をさせないか」の設計**が同等以上に重要になります。

これは決してAIの能力不足を意味しません。むしろ、**AIが指示を忠実に実行しすぎる**からこそ必要な防御策です。

robots.txtでクローラーを制御するように、AIエージェントには「制約ファースト」のプロンプト設計が求められます。この思考法は、今後あらゆるAI活用の場面で標準になっていくでしょう。

## まとめ

- AIは「賢く判断」せず「指示を忠実に実行」する
- 暗黙の制約は明示的に定義する必要がある
- 禁止事項、スコープ限定、レート制限を設計に組み込む
- 「何をさせないか」を設計する能力が重要になる

AIエージェントの普及は、エンジニアリングに新しいレイヤーの設計思想を追加します。コードを書く技術と同じくらい、**制約を設計する技術**を磨いていきましょう。
